function setCookie(a,b,c){var d=new Date();d.setTime(d.getTime()+(c*24*60*60*1000));var e="expires="+d.toUTCString();document.cookie=a+"="+b+"; "+e}function getCookie(a){var b=a+"=";var d=document.cookie.split(';');for(var i=0;i<d.length;i++){var c=d[i];while(c.charAt(0)==' '){c=c.substring(1)}if(c.indexOf(b)==0){return c.substring(b.length,c.length)}}return""}function C2F(c){return Math.round((c*1.8+32)*10)/10}function F2C(f){return Math.round((f-32)/1.8*10)/10}function srmColor(v){var a=["#92d4f2","#FFE699","#FFD978","#FFCA5A","#FFBF43","#FCB124","#F8A700","#F39C00","#EA8F00","#E68500","#DE7C00","#D77200","#D06900","#DC6200","#C35901","#BB5000","#B64C00","#B04500","#A63E00","#A03700","#9C3200","#962D00","#8F2A00","#872300","#811E00","#7C1A01","#771900","#701400","#6A0E00","#660D00","#5E0C00","#5A0A03","#600902","#530908","#4B0505","#460605","#440607","#3F0708","#3A0608","#3A080B","#36080A"];var i=Math.round(v);if(i>40)i=40;return a[i]}var EEPROM={"s_kp":{max:100,min:-100,inc:1,decode:function(v){return v-100},encode:function(v){return v+100}},"s_ki":{max:155,min:-100,inc:1,decode:function(v){return v-100},encode:function(v){return v+100}},"s_kd":{max:100,min:-100,inc:1,decode:function(v){return v-100},encode:function(v){return v+100}},"s_sample_time":{max:3500,min:1500,inc:250,decode:function(v){return v*250},encode:function(v){return Math.round(v/250)}},"s_window":{max:7500,min:4000,inc:250,decode:function(v){return v*250},encode:function(v){return Math.round(v/250)}},"s_pwm":{max:100,min:0,inc:1},"s_cal":{max:5,min:-5,inc:0.1,decode:function(v){return(v-50)/10},encode:function(v){return v*10+50}},"s_unit":{max:1,min:0,inc:1,labels:["°C","°F"],},"s_sensor":{max:1,min:0,inc:1,labels:["Inside","Outside"]},"s_boil":{max:120,min:80,inc:1},"s_pumpcycle":{max:15,min:5,inc:1},"s_pumprest":{max:5,min:0,inc:1},"s_pumppremash":{max:1,min:0,inc:1,labels:["Off","ON"]},"s_pumpmash":{max:1,min:0,inc:1,labels:["Off","ON"]},"s_pumpmashout":{max:1,min:0,inc:1,labels:["Off","ON"]},"s_pumpboil":{max:1,min:0,inc:1,labels:["Off","ON"]},"s_pumpstop":{max:120,min:80,inc:1},"s_pipe":{max:1,min:0,inc:1,labels:["Passive","Active"]},"s_skipadd":{max:1,min:0,inc:1,labels:["NO","YES"]},"s_skipremove":{max:1,min:0,inc:1,labels:["NO","YES"]},"s_skipiodine":{max:1,min:0,inc:1,labels:["NO","YES"]},"s_iodine":{max:120,min:0,inc:1},"s_whirlpool":{max:2,min:0,labels:["Off","Cold","Hot"]}};var BMSetting={values:{},editing:{},enabled:false,celius:true,setEnabled:function(e){this.enabled=e;if(e){$("#esetting").button({disabled:false})}else{$("#esetting").button({disabled:true})}},display:function(){var c=this.celius;$.each(this.values,function(k,v){var p=EEPROM[k];var a;if(typeof p["labels"]=="undefined"){if(typeof p["decode"]=="undefined")a=v;else a=p.decode(v)}else{a=p["labels"][v]}if(!c){if(k=="s_cal")a=a*1.8;else if(k=="s_boil"||k=="s_pumpstop")a=C2F(a)}$('#'+k).text(a)})},setting:function(s){this.values=s;this.display();if($("#esetting").button("option","icons").primary!="ui-icon-pencil"){$("#esetting").button("option","icons",{primary:"ui-icon-pencil"});$("#savesetting").hide()}},unitCelius:function(c){if(this.celius!=c){$(".tmp_unit").text((c)?"°C":"°F");this.celius=c}},valuechange:function(s){var n=$(s).attr("name");var v=$(s).spinner("value");var a=$(s).spinner("option","min");var b=$(s).spinner("option","max");if(v<a)v=a;if(v>b)v=b;$(s).spinner("value",v);if(!this.celius){if(n=="s_cal")v=v/1.8;else if(n=="s_boil"||n=="s_pumpstop")v=F2C(v)}if(typeof EEPROM[n]["encode"]=="undefined")this.editing[n]=v;else this.editing[n]=EEPROM[n].encode(v)},switchchange:function(n,c){this.editing[n]=c},selectionchange:function(n,v){this.editing[n]=v},editsettings:function(){var f=this.values;var b=this;$.each(EEPROM,function(k,p){var s=$('#'+k).empty();var c=(typeof p["decode"]=="undefined")?f[k]:p.decode(f[k]);if(typeof p["labels"]=="undefined"){var d=p["min"];var e=p["max"];if(!b.celius){if(k=="s_cal"){c=c*1.8;d=d*1.8;e=e*1.8}else{if(k=="s_boil"||k=="s_pumpstop"){c=C2F(c);d=C2F(d);e=C2F(e)}}}$("<input size=\"4\" value=\""+c+"\"></input>").appendTo(s);s.find("input").spinner({min:d,max:e,step:p["inc"],change:function(){b.valuechange(this)}}).attr("name",k)}else if((p["labels"]).length==2){$("<input type=\"checkbox\" value=\""+c+"\""+((c)?"checked":"")+"></input>").appendTo(s);s.find("input[type=checkbox]").switchButton({on_label:p["labels"][1],off_label:p["labels"][0],name:k,on_callback:function(){b.switchchange(k,(this.options["checked"])?1:0)},off_callback:function(){b.switchchange(k,(this.options["checked"])?1:0)}})}else{var h="";$.each(p["labels"],function(i,a){var b=(c==i)?"checked":"";h=h+"<input type=\"radio\" name=\""+k+"\" value=\""+i+"\""+b+" >"+p["labels"][i]+"<br />"});$(h).appendTo(s);s.find("input").on("click",function(){b.selectionchange(k,s.find("input:checked").val())})}});this.editing={}},finishSaving:function(s){if(s){var b=this;$.each(b.editing,function(k,v){b.values[k]=v});b.display();$("#esetting").button("option","icons",{primary:"ui-icon-pencil"});$("#savesetting").hide()}else{$("input").spinner({disabled:false})}$("button").button({disabled:false})},init:function(a){var b=this;$("#esetting").button({disabled:false,text:false,icons:{primary:"ui-icon-pencil"}}).click(function(){if($("#esetting").button("option","icons").primary=="ui-icon-pencil"){$("#esetting").button("option","icons",{primary:"ui-icon-arrowreturnthick-1-w"});$("#savesetting").show();b.editsettings()}else{$("#esetting").button("option","icons",{primary:"ui-icon-pencil"});$("#savesetting").hide();b.display()}});$("#savesetting").button({text:false,icons:{primary:"ui-icon-disk"}}).click(function(){if(!b.enabled){alert("BrewManiac is not in idle state");return}if(Object.keys(b.editing).length==0){$("#esetting").button("option","icons",{primary:"ui-icon-pencil"});$("#savesetting").hide();b.display();return}$("button").button({disabled:true});$("input").spinner({disabled:true});a.savesetting(b.editing)}).hide()}};var BMRecipe={auto:{},eauto:{},enabled:false,celius:true,setEnabled:function(e){this.enabled=e;if(e)$("#editauto").button({disabled:false});else $("#editauto").button({disabled:true})},updateRecipe:function(d){this.auto=d;this.display();if($("#editauto").button("option","icons").primary!="ui-icon-pencil"){this.stopEditRecipe()}},unitCelius:function(a){this.celius=a;if($("#editauto").button("option","icons").primary!="ui-icon-pencil"){this.stopEditRecipe()}this.display()},display:function(){var d=this.auto;var c=this.celius;$.each(d.rest_tm,function(i,v){var t=(c)?d.rest_tp[i]:C2F(d.rest_tp[i]);if(i==0){$("#s0_tp").text(t)}else{if(v==0){$('#s'+i+'_tm').text("-");$('#s'+i+'_tp').text("-")}else{$('#s'+i+'_tm').text(v);$('#s'+i+'_tp').text(t)}}});$("#boiltime").text(d.boil);$("#auto_table tr:gt("+$("#boiltime").closest("tr").index()+")").remove();var t=$("#auto_table");$.each(d.hops,function(i,h){$("<tr><td>Hop#"+(i+1)+"</td><td colspan=\"2\">"+h+" min</td></tr>").appendTo(t)})},minRT:[20,25,35,45,50,60,60,75],maxRT:[75,55,50,60,70,76,76,80],minRT_F:[68,77,95,113,122,140,167,167],maxRT_F:[167,131,122,140,158,169,176,176],rtmChange:function(s){var i=$(s).attr("name").substring(2);var v=$(s).spinner("value");if(v>140)v=140;var a=(i>5)?1:0;if(v<a)v=a;$(s).spinner("value",v);this.eauto.rest_tm[i]=v},rtpChange:function(s){var i=$(s).attr("name").substring(2);var v=$(s).spinner("value");var a=$(s).spinner("option","min");var b=$(s).spinner("option","max");if(v<a)v=a;if(v>b)v=b;$(s).spinner("value",v);this.eauto.rest_tp[i]=(this.celius)?v:F2C(v)},btChange:function(s){var v=$(s).spinner("value");if(v>140)v=140;if(v<1)v=1;$(s).spinner("value",v);this.eauto.boil=v;this.listhop()},hchange:function(s){var i=$(s).attr("name").substring(1);this.eauto.hops.splice(i,1);var v=$(s).spinner("value");if(v<1)v=1;if(v>this.eauto.boil)v=this.eauto.boil;this.eauto.hops.push(v);this.eauto.hops.sort(function(a,b){return b-a});this.listhop()},dhop:function(s){var i=$(s).attr("name").substring(2);this.eauto.hops.splice(i,1);$(s).closest("tr").remove()},ahop:function(){var v=this.eauto.hops[this.eauto.hops.length-1]-1;if(v<1)v=1;this.eauto.hops.push(v);this.listhop()},listhop:function(){$("#auto_table tr:gt("+$("#boiltime").closest("tr").index()+")").remove();var t=$("#auto_table");var b=this;$.each(b.eauto.hops,function(i,h){var e=$("<tr><td>Hop#"+(i+1)+"</td><td colspan=\"2\"><input size=\"3\" name=\"h"+i+"\" value=\""+h+"\"></input>min <button>x</button></td></tr>").appendTo(t);e.find("input").spinner({min:1,max:b.eauto.boil,change:function(){b.hchange(this)}});e.find("button").css("color","red").attr("name","dh"+i).button({text:false,icons:{primary:"ui-icon-trash"}}).click(function(){b.dhop(this)})})},edit:function(){$("#addhop").show();$("#saveauto").show();var b=this;b.eauto=$.extend(true,{},this.auto);var a=$("<input size=\"3\" value=\""+this.auto.boil+"\"></input>").appendTo($('#boiltime').empty()).spinner({min:1,max:140,change:function(){b.btChange(this)}});b.listhop();for(var i=0;i<8;i++){if(i!=0){var c=$('#s'+i+'_tm').empty();$("<input size=\"3\" value=\""+b.eauto.rest_tm[i]+"\"></input>").appendTo(c);var d=(i>5)?1:0;c.find("input").spinner({min:d,max:140,change:function(){b.rtmChange(this)}}).attr("name",'tm'+i)}var e=$('#s'+i+'_tp').empty();var v=(this.celius)?b.eauto.rest_tp[i]:C2F(b.eauto.rest_tp[i]);var d=(this.celius)?b.minRT[i]:b.minRT_F[i];var f=(this.celius)?b.maxRT[i]:b.maxRT_F[i];if(v<d)v=d;if(v>f)v=f;b.eauto.rest_tp[i]=v;$("<input size=\"3\" value=\""+v+"\"></input>").appendTo(e);e.find("input").spinner({min:d,max:f,change:function(){b.rtpChange(this)}}).attr("name",'tp'+i)}},stopEditRecipe:function(){$("#editauto").button("option","icons",{primary:"ui-icon-pencil"});$("#saveauto").hide();$("#addhop").hide()},validate:function(){if(this.eauto.rest_tm[6]==0||this.eauto.rest_tm[7]==0)return false;var a=this.eauto.boil;if(this.eauto.hops.length>0){var b=this.eauto.hops[0];if(b>a)return false;for(var i=1;i<this.eauto.hops.length;i++){var v=this.eauto.hops[i];if(v>=b)return false;b=v}}return true},finishSaveRecipe:function(a){if(a){this.auto=this.eauto;this.display();this.stopEditRecipe()}else{$("input").spinner({disabled:false})}$("button").button({disabled:false})},init:function(a){var b=this;$("#editauto").button({disabled:false,text:false,icons:{primary:"ui-icon-pencil"}}).click(function(){if($("#editauto").button("option","icons").primary=="ui-icon-pencil"){b.edit();$("#editauto").button("option","icons",{primary:"ui-icon-arrowreturnthick-1-w"})}else{b.display();b.stopEditRecipe()}});$("#saveauto").button({disabled:false,text:false,icons:{primary:"ui-icon-disk"}}).click(function(){if(!b.enabled){alert("BrewManiac is not in idle state");return}if(b.validate()){$("button").button({disabled:true});$("input").spinner({disabled:true});a.saveRecipe(b.eauto)}else{alert("Invalid value!")}}).hide();$("#addhop").button({disabled:false,text:false,icons:{primary:"ui-icon-plusthick"}}).click(function(){b.ahop()}).hide()}};var BMScreen={ctemp:0,stemp:0,pwm:0,pwmOn:false,screen:"U",bm:null,celius:true,C_inactive:"white",C_water:"#92d4f2",srm:3,wortcolor:3,pumping:null,htimer:null,h_animated:0,runPump:function(){if(this.ptimer)return;this.ptimer=setInterval(function(){var m=parseInt($("#pumprun").css("margin-left"));m-=300;if(m<-600)m=0;var a=m+"px";$("#pumprun").css({"margin-left":a})},300)},stopPump:function(){if(this.ptimer){clearInterval(this.ptimer);this.ptimer=null}},runHeater:function(){if(this.htimer)return;var b=this;this.htimer=setInterval(function(){var a=[0,-300,-600,-300];b.h_animated++;if(b.h_animated>3)b.h_animated=0;var c=a[b.h_animated]+"px";$("#heating").css({"margin-left":c})},1000)},stopHeater:function(){if(this.htimer){clearInterval(this.htimer);this.htimer=null}},setSrm:function(s){this.srm=s;$("#bmicon").css("background-color",srmColor(s))},kettle:function(c){var a;if(c=="malt"){$("#malt").show();return}else if(c=="dmalt"){$("#malt").hide();return}else if(c=="empty")a=this.C_inactive;else{if(c=="water")this.srm=0;else if(c=="wort")this.srm=this.wortcolor;a=srmColor(this.srm)}$("#bmicon").css("background-color",a)},autolist:function(){var a=this.bm.autoAllStages();var t=$("#auto-t").empty();var b=(this.celius)?"°C":"°F";b="<span class=\"tmp_unit\">"+b+"</span>";var c={addmalt:STR.AddMalt,removemalt:STR.RemoveMalt,boilend:STR.BoilEnd,cooling:STR.Cooling};for(i=0;i<a.length;i++){s=a[i];if(s.type=="mash"){var d=(this.celius)?s.temp:C2F(s.temp);$("<tr><td>"+STR.stageName[s.stage]+"</td><td>"+d+b+"</td><td>"+((s.stage)?(s.time+STR.min):"-")+"</td></tr>>").appendTo(t)}else if(s.type=="event"){$("<tr><td>"+c[s.name]+"</td><td>-</td><td>-</td></tr>>").appendTo(t)}else if(s.type=="boil"){$("<tr><td>"+STR.Boil+"</td><td>-</td><td>"+s.time+STR.min+"</td></tr>>").appendTo(t)}else if(s.type=="hop"){$("<tr><td>"+STR.HopN+(s.index+1)+"</td><td>-</td><td>"+s.time+STR.min+"</td></tr>>").appendTo(t)}}},inStage:function(i){$("#auto-t tr:eq("+i+")").removeClass("run").addClass("running");$("#auto-t tr:lt("+i+")").removeClass("running").addClass("run");$("#auto-t tr:gt("+i+")").removeClass("running").removeClass("run")},unitCelius:function(a){this.celius=a;this.currenttemp(this.ctemp);if(this.isRunning(this.screen))this.settingtemp(this.stemp)},isRunning:function(s){return(s=="A"||s=="M")},setScreen:function(s,a){if(s=="S")$("#settingstate").show();else $("#settingstate").hide();if(s=="U")$("#errorstate").show();else $("#errorstate").hide();if(!this.isRunning(s)){this.clear_settingtemp();if(this.isRunning(this.screen))this.kettle("empty")}else if(s=="M"){this.kettle("water")}else if(s=="A"){if(a<1)this.kettle("water");else this.kettle("wort")}if(s=="A"&&a>1&&a<=7)this.kettle("malt");else this.kettle("dmalt");if(s=="A"){if(this.screen!="A"){this.autolist();$("#auto-p").show()}}else{$("#auto-p").hide()}this.screen=s},heatStatus:function(s){if(s==0){$("#heating").hide();$("#heater_inact").hide();this.stopHeater()}else if(s==1){$("#heating").show();$("#heater_inact").hide();this.runHeater()}else{$("#heating").hide();$("#heater_inact").show();this.stopHeater()}},pumpStatus:function(s){if(s==1){$("#pump_inact").hide();$("#pumprun").show();this.runPump()}else{$("#pumprun").hide();$("#pump_inact").show();this.stopPump()}},currenttemp:function(t){this.ctemp=t;var v=(this.celius)?t:C2F(t);$("#ctemp").text(v)},clear_settingtemp:function(){$("#stemp").text(" - ")},settingtemp:function(t){this.stemp=t;var v=(this.celius)?t:C2F(t);$("#stemp").text(v)},showPwm:function(s){if(s)$("#pwmcontainer").show();else $("#pwmcontainer").hide()},pwmValue:function(v){this.pwm=v;$("#pwmvalue").text(v)},setPwmOn:function(o){this.pwmOn=o;this.showPwm(o)},displaytime:function(t){if(isNaN(t))return;var m=Math.floor(t/60);var s=t-m*60;$("#stime").text(""+((m>9)?m:("0"+m))+":"+((s>9)?s:("0"+s)))},clearTime:function(){$("#stime").text("-")},openDiaTimer:null,initDialog:function(a){$(a).hide();var b=this;$(a).dialog({autoOpen:false,modal:true,show:{effect:"bounce",duration:1000},hide:{effect:"fade",duration:1000},close:function(){Beep.pause()},buttons:{Ok:function(){$(this).dialog("close");if(b.openDiaTimer)clearTimeout(b.openDiaTimer)}}})},popDialog:function(a,c){$(a).dialog("open");var b=this;if((typeof c=="undefined")||c)b.openDiaTimer=setTimeout(function(){$(a).dialog("close");b.openDiaTimer=null},5000)},soundTimeout:null,sound:function(t){var b=this;if(b.soundTimeout)clearTimeout(b.soundTimeout);Beep.pause();Beep.loop=true;Beep.play();if(t>0)b.soundTimeout=setTimeout(function(){b.soundTimeout=null;Beep.pause()},t*1000)},showInfo:function(s){if(s)$("#info").show();else $("#info").hide()},setInfo:function(t){$("#info").text(t).show("drop",{direction:"down"},500,function(){setTimeout(function(){$("#info").hide("drop",{direction:"down"},1000)},3000)})},brewevent:function(e){if(e==1){this.sound(3);this.setInfo(STR.event[e])}else if(e==2||e==3){this.sound(5);if(e==2)this.popDialog("#d_addmalt");else this.popDialog("#d_removemalt")}else if(e==7){this.sound(5);this.popDialog("#d_addhop")}else if(e<=10){this.sound(5);this.setInfo(STR.event[e])}else if(e==99){this.sound(5);this.setInfo(STR.event[11])}},error:function(c){if(c=="disc"){this.sound(0);this.popDialog("#d_ConnectionError",false)}else if(c=="s_disc"){this.sound(0);this.popDialog("#d_SerialError",false)}this.setScreen("U")},toggleButton:function(){if($("#showbtn").button("option","icons").primary=="ui-icon-circle-triangle-s"){$("#showbtn").button("option","icons",{primary:"ui-icon-circle-triangle-n"})}else{$("#showbtn").button("option","icons",{primary:"ui-icon-circle-triangle-s"})}$("#bpannel").toggle("slide",{direction:"up"},500)},btnPressed:false,btnClick:function(k,l){var b=this;if(b.btnPressed)return;b.btnPressed=true;this.bm.sendButton(k,l,function(){b.btnPressed=false})},home:function(){this.btnClick("home",false)},init:function(b){var c=getCookie("wort");if(c!="")this.wortcolor=c;else this.wortcolor=3;this.bm=b;this.showPwm(false);this.showInfo(false);this.clear_settingtemp();$("#pumprun").hide();$("#heating").hide();$("#heater_inact").hide();$("#malt").hide();$("#settingstate").hide();$("#errorstate").hide();this.initDialog("#d_addmalt");this.initDialog("#d_removemalt");this.initDialog("#d_addhop");this.initDialog("#d_ConnectionError");this.initDialog("#d_SerialError");$("#srmc").hide();var b=this;$("#bmicon").click(function(){if(!b.isRunning(b.screen))return;$("#srmc").toggle();$("#srmv").text(b.srm);$("#srm").slider({min:0,max:40,value:b.srm,slide:function(a,c){setCookie("wort",c.value,365);b.wortcolor=c.value;b.setSrm(c.value);$("#srmv").text(c.value)}})});var d=getCookie("warning");if(d!=1){$("#d_warning").dialog({resizable:false,dialogClass:"no-close",modal:true,buttons:{"Agree":function(){$(this).dialog("close")}}});$('#nshow').change(function(){setCookie("warning",($(this).is(':checked'))?1:0,365)})}else $("#d_warning").hide();$("#bpannel").hide();$("#showbtn").button({disabled:false,text:false,icons:{primary:"ui-icon-circle-triangle-s"}}).click(function(){b.toggleButton()});$("#d_home_confirm").hide();$("#btn-home").button({disabled:false,text:false,icons:{primary:"ui-icon-home"}}).click(function(){$("#d_home_confirm").dialog({autoOpen:true,modal:true,buttons:{Ok:function(){$(this).dialog("close");b.home()},Cancel:function(){$(this).dialog("close")}}})});function sb(a){var c=$("#btn-"+a).css("background");$("#btn-"+a).bind("touchstart mousedown",function(e){e.preventDefault();this.dt=Date.now();$(this).css("background","#FF1111");return false}).bind("touchend mouseup",function(e){e.preventDefault();if(typeof this.dt!="undefined"){$(this).css("background",c);if(Date.now()-this.dt>1000)b.btnClick(a,true);else b.btnClick(a,false);return false}}).bind("mouseleave",function(e){if(typeof this.dt!="undefined"){$(this).css("background",c);this.dt=null}}).click(function(){return false})}sb("up");sb("down");sb("start");sb("enter");$("#btn-hint").hide()},buttons:function(a){var b=(typeof ButtonLabels[a]=="undefined")?{u:"",d:"",s:"",e:"",i:""}:ButtonLabels[a];$("#btn-up").text(b.u);$("#btn-down").text(b.d);$("#btn-start").text(b.s);$("#btn-enter").text(b.e);if(b.i!=""){$("#btn-hint td").text(b.i);$("#btn-hint").show()}else $("#btn-hint").hide()}};var BM={setting_url:"settings.php",automation_url:"automation.php",saveauto_url:"saveauto.php",ssavesetting_url:"savesettings.php",button_url:"button.php",status_url:"status.php",runningTime:0,timer:null,settings:{},s_settingS:{},auto:{},s_auto:{},celius:true,state:-1,hopN:0,updatingSetting:false,updatingRecipe:false,stageMap:[],ssebroken:true,wdt:null,bc:{up:1,down:2,start:4,enter:8,home:3},sendButton:function(k,l,d){var e=this.bc[k]+((l)?16:0);$.ajax({url:this.button_url+"?code="+e,type:"GET",success:function(){d()},error:function(a,b,c){console.log(c)},})},getsetting:function(){var o=this;$.ajax({url:this.setting_url,type:"GET",dataType:"json",success:function(a){if(a.code==0){o.proc_settings(a.data)}},error:function(a,b,c){console.log(c)},})},savesetting:function(d){this.s_settings=d;var b=this;this.updatingSetting=true;$.ajax({url:this.ssavesetting_url,type:"POST",data:{data:JSON.stringify(d)},success:function(){b.startRecoveryTimer()},error:function(a,c,d){alert("error save setting, server response:"+d);b.finishSettingSave(false)}})},unitSetting:function(u){var c=(u==0);if(c!=this.celius){this.celius=c;BMSetting.unitCelius(c);BMRecipe.unitCelius(c);BMScreen.unitCelius(c)}},proc_settings:function(s){this.settings=s;if("s_unit"in this.settings){this.unitSetting(s["s_unit"])}BMSetting.setting(s)},getauto:function(){var b=this;$.ajax({url:this.automation_url,type:"GET",dataType:"json",success:function(a){if(a.code==0){b.procRecipe(a.data)}},error:function(a,b,c){console.log(c)},})},procRecipe:function(d){this.auto=d;BMRecipe.updateRecipe(d)},saveRecipe:function(d){this.s_auto=d;var b=this;b.updatingRecipe=true;$.ajax({url:b.saveauto_url,type:"POST",data:{data:JSON.stringify(d)},success:function(){b.startRecoveryTimer()},error:function(a,c,d){b.finishSaveRecipe(false);alert("Error saving automation, server response:"+d)}})},bmstate:function(s){if(this.state==s)return;if(this.state==-1){if(typeof this.auto.boil=="undefined"){this.getsetting();this.getauto()}}if(s==101){if(!(this.updatingSetting||this.updatingRecipe)){BMRecipe.setEnabled(true);BMSetting.setEnabled(true)}}else{BMRecipe.setEnabled(false);BMSetting.setEnabled(false)}if(s>=0&&s<=11){BMScreen.setScreen("A",s);this.autostage(s)}else{if(s==100){BMScreen.setScreen("M")}else if(s==101){BMScreen.setScreen("I");this.stopRunningTime();BMScreen.clearTime()}else if(s==102){BMScreen.setScreen("S");this.stopRunningTime();BMScreen.clearTime()}else if(s<0){BMScreen.setScreen("U");this.stopRunningTime();BMScreen.clearTime()}}this.state=s},stopRunningTime:function(){if(this.timer)clearInterval(this.timer);this.timer=null},refTime:0,countDir:0,calTime:function(){var t=this.runningTime+this.countDir*Math.round((Date.now()-this.refTime)/1000);return(t<0)?0:t},startRunningTime:function(t){b=this;b.runningTime=t;if(isNaN(t))return;b.refTime=Date.now();b.timer=setInterval(function(){BMScreen.displaytime(b.calTime())},1000)},checkRunningTime:function(t){var a=this.calTime();if((a-t)>5||(a-t)<-5){this.stopRunningTime();this.startRunningTime(t)}},finishSaveRecipe:function(a){this.stopRecoveryTimer();this.updatingRecipe=false;BMRecipe.finishSaveRecipe(a)},finishSettingSave:function(a){this.stopRecoveryTimer();this.updatingSetting=false;BMSetting.finishSaving(a)},recoveryTimout:null,stopRecoveryTimer:function(){if(this.recoveryTimout){clearTimeout(this.recoveryTimout);this.recoveryTimout=null}},startRecoveryTimer:function(){var b=this;b.recoveryTimout=setTimeout(function(){b.recoveryTimout=null;alert("Update failed, check connections");if(b.updatingRecipe)b.finishSaveRecipe(false);if(b.updatingSetting)b.finishSettingSave(false)},10000)},init:function(){BMScreen.init(this);BMSetting.init(this);BMRecipe.init(this);this.getsetting();this.getauto();this.setupEvent()},timerControl:function(r,t,c,p){var b=this;b.countDir=(c==0)?-1:1;if(!p){if(b.timer==null){b.startRunningTime(t)}else{b.checkRunningTime(t)}}else{if(b.timer)b.stopRunningTime();if(r&&b.state<=8&&b.state>0){BMScreen.displaytime(t)}else if(b.state<8&&b.state>0){BMScreen.displaytime(b.auto.rest_tm[b.state]*60)}else if(b.state==8){BMScreen.displaytime(BM.auto.boil*60)}else{BMScreen.clearTime()}}},updateData:function(v){if(v=="recipe"){if(this.updatingRecipe){this.auto=this.s_auto;this.finishSaveRecipe(true)}else{this.getauto()}}else if(v=="setting"){var b=this;if(b.updatingSetting){$.each(b.s_settings,function(k,v){b.settings[k]=v;if(k=="s_unit")b.unitSetting(v)});b.finishSettingSave(true)}else{b.getsetting()}}},errorCode:function(a){this.bmstate(-1);BMScreen.error("s_disc")},watchdog:function(){var b=this;b.wdt=setTimeout(function(){location.reload()},20000)},kick_wdt:function(){if(this.wdt)clearTimeout(this.wdt);this.watchdog()},setupEvent:function(){var b=this;if(typeof EventSource!="undefined"){var d=new EventSource(BM.status_url);d.onmessage=function(e){b.kick_wdt();b.ssebroken=false;var a=JSON.parse(e.data);var c={pump:function(v){BMScreen.pumpStatus(v)},heat:function(v){BMScreen.heatStatus(v)},temp:function(v){BMScreen.currenttemp(v)},stemp:function(v){BMScreen.settingtemp(v)},event:function(v){b.brewevent(v)},pwm:function(v){BMScreen.pwmValue(v)},pwmon:function(v){BMScreen.setPwmOn(v==1)},update:function(v){b.updateData(v)},code:function(v){b.errorCode(v)},btn:function(v){BMScreen.buttons(v)}};$.each(a,function(k,v){if(typeof(c[k])!="undefined"){c[k](v)}});if(typeof(a["tr"])!="undefined"&&typeof(a["timer"])!="undefined"&&typeof(a["state"])!="undefined"){b.timerControl(a["tr"],a["timer"],a["counting"],a["paused"]);b.bmstate(a["state"]);b.autoProgressBytime(a["tr"],a["state"],a["timer"])}};d.onerror=function(){var b=this;b.ssebroken=true;setTimeout(function(){if(b.ssebroken)BMScreen.error("disc")},5000)}}else{console.log("not support SSE");alert("Incompatible Browser!")}},brewevent:function(e){var b=this;if(e==5&&b.timer)b.stopRunningTime();if(e==1){if(b.state>0&&b.state<8)b.startRunningTime(b.auto.rest_tm[b.state]*60);else if(b.state==8)b.startRunningTime(b.auto.boil*60)}b.autoProgressByevent(e);BMScreen.brewevent(e)},log:function(s){var d=new Date();$("<tr><td>"+d.toLocaleTimeString()+"</td><td>"+s+"</td></tr>").appendTo("#log-t")},autoAllStages:function(){var a=[];var b=0;for(i=0;i<8;i++){if(this.auto.rest_tm[i]>0||i==0){a.push({type:"mash",stage:i,temp:BM.auto.rest_tp[i],time:BM.auto.rest_tm[i]});this.stageMap[i]=b++}if(i==0){a.push({type:"event",name:"addmalt"});b++}}a.push({type:"event",name:"removemalt"});b++;a.push({type:"boil",time:BM.auto.boil});this.stageMap[8]=b++;$.each(BM.auto.hops,function(i,h){a.push({type:"hop",index:i,time:h});b++});a.push({type:"event",name:"boilend"});b++;a.push({type:"event",name:"cooling"});this.stageMap[9]=b++;this.hopN=0;return a},autostage:function(s){BMScreen.inStage(this.stageMap[s]);if(s<8){BMScreen.settingtemp(BM.auto.rest_tp[s]);if(s==0)BMScreen.clearTime();else BMScreen.displaytime(BM.auto.rest_tm[s]*60)}else if(s==8){BMScreen.settingtemp(BM.settings.s_boil);BMScreen.displaytime(BM.auto.boil*60)}},autoProgressByevent:function(e){if(e==2){BMScreen.inStage(1)}else if(e==3){BMScreen.inStage(BM.stageMap[7]+1)}else if(e==10){BMScreen.inStage(BM.stageMap[9])}},autoProgressBytime:function(a,b,c){if(!a||b!=8)return;if(c==0)c=this.auto.boil*60;var i=this.hopN;for(;i<this.auto.hops.length;i++){if(c>this.auto.hops[i]*60){break}}if(i!=this.hopN){this.hopN=i;BMScreen.inStage(BM.stageMap[8]+i+1)}}};